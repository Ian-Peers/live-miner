#!/bin/bash

set -eu

declare -a slots

layouts=

function parse {
	local slot="$1"
	local class="$2"
	local vendor="$3"
	local device="$4"

	if [[ $class == 0300 && $vendor == 1002 ]]; then
		if [[ ${#slots[@]} == 0 ]]; then
			layouts="Screen \"s${#slots[@]}\" 0 0"
		else
			layouts+=$'\n'
			layouts+="Screen \"s${#slots[@]}\" RightOf \"s$((${#slots[@]}-1))\""
		fi
		slots[${#slots[*]}]=$slot
	fi
}

while read line; do
	eval parse $line
done < <(lspci -mm -n)

printf '# xorg.conf generated by live-miner\n\n'

if [[ -z $layouts ]]; then
	printf '# No ATI video cards detected!\n'
	exit 0
fi

cat <<- EOF
	Section "ServerLayout"
		Identifier "live-miner layout"
		$layouts
	EndSection
EOF

for ((i=0; i<${#slots[@]}; ++i)); do
	busid=''
	t=${slots[$i]/:/ }; t=${t/./ }
	for n in $t; do
		if [[ -n $busid ]]; then
			busid+=:
		fi
		busid+=$(printf '%d' 0x$n)
	done

	cat <<- EOF

		Section "Screen"
			Identifier "s$i"
			Device     "d$i"
		EndSection

		Section "Device"
			Identifier "d$i"
			Driver     "fglrx"
			BusID      "PCI:$busid"
		EndSection
	EOF
done
