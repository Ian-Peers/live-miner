#!/bin/bash

set -eux

declare -a addresses

function parse {
	address="$1"
	class="$2"
	vendor="$3"
	device="$4"

	if [[ $class == 0300 && $vendor == 1002 ]]; then
		if [[ ${#addresses[@]} == 0 ]]; then
			layouts="Screen \"s${#addresses[@]}\" 0 0"
		else
			layouts+=$'\n'
			layouts+="Screen \"s${#addresses[@]}\" RightOf \"s$((${#addresses[@]}-1))\""
		fi
		addresses[${#addresses[*]}]=$address
	fi
}

while read line; do
	eval parse $line
done < <(lspci -mn)

cat <<- EOF
	# xorg.conf generated by live-miner

	Section "ServerLayout"
		Identifier "live-miner layout"
		$layouts
	EndSection
EOF

for ((i=0; i<${#addresses[@]}; ++i)); do
	busid=''
	t=${addresses[$i]/:/ }; t=${t/./ }
	for n in $t; do
		if [[ -n $busid ]]; then
			busid+=:
		fi
		busid+=$(printf '%d' 0x$n)
	done

	cat <<- EOF

		Section "Screen"
			Identifier "s$i"
			Device     "d$i"
		EndSection

		Section "Device"
			Identifier "d$i"
			Driver     "fglrx"
			BusID      "PCI:$busid"
		EndSection
	EOF
done
